name: Update Homebrew Formula

on:
  repository_dispatch:
    types: [bugster-cli-release]

permissions:
  contents: write

jobs:
  update-formula:
    name: Update Bugster Formula
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract versions and SHA256 from payload
        id: versions
        run: |
          BUGSTER_VERSION="${{ github.event.client_payload.bugster_version }}"
          PLAYWRIGHT_VERSION="${{ github.event.client_payload.playwright_version }}"
          PLAYWRIGHT_MCP_VERSION="${{ github.event.client_payload.playwright_mcp_version }}"
          SHA256_INTEL="${{ github.event.client_payload.sha256_intel }}"
          SHA256_ARM64="${{ github.event.client_payload.sha256_arm64 }}"
          SHA256_LINUX="${{ github.event.client_payload.sha256_linux }}"
          
          # Remove 'v' prefix if present for version field (Homebrew doesn't use it)
          VERSION_NO_V="${BUGSTER_VERSION#v}"
          
          echo "bugster_version=$BUGSTER_VERSION" >> "$GITHUB_OUTPUT"
          echo "bugster_version_no_v=$VERSION_NO_V" >> "$GITHUB_OUTPUT"
          echo "playwright_version=$PLAYWRIGHT_VERSION" >> "$GITHUB_OUTPUT"
          echo "playwright_mcp_version=$PLAYWRIGHT_MCP_VERSION" >> "$GITHUB_OUTPUT"
          echo "sha256_intel=$SHA256_INTEL" >> "$GITHUB_OUTPUT"
          echo "sha256_arm64=$SHA256_ARM64" >> "$GITHUB_OUTPUT"
          echo "sha256_linux=$SHA256_LINUX" >> "$GITHUB_OUTPUT"
          
          echo "Extracted versions and SHA256:"
          echo "  Bugster: $BUGSTER_VERSION (formula version: $VERSION_NO_V)"
          echo "  Playwright: $PLAYWRIGHT_VERSION"
          echo "  Playwright MCP: $PLAYWRIGHT_MCP_VERSION"
          echo "  SHA256 Intel: $SHA256_INTEL"
          echo "  SHA256 ARM64: $SHA256_ARM64"
          echo "  SHA256 Linux: $SHA256_LINUX"

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Generate Formula from template
        env:
          BUGSTER_VERSION: ${{ steps.versions.outputs.bugster_version }}
          BUGSTER_VERSION_NO_V: ${{ steps.versions.outputs.bugster_version_no_v }}
          PW_VERSION: ${{ steps.versions.outputs.playwright_version }}
          MCP_VERSION: ${{ steps.versions.outputs.playwright_mcp_version }}
          SHA256_INTEL: ${{ steps.versions.outputs.sha256_intel }}
          SHA256_ARM64: ${{ steps.versions.outputs.sha256_arm64 }}
          SHA256_LINUX: ${{ steps.versions.outputs.sha256_linux }}
        run: |
          # Generate formula from ERB template using Ruby
          ruby <<'RUBY'
          require 'erb'
          
          bugster_version = ENV['BUGSTER_VERSION']
          bugster_version_no_v = ENV['BUGSTER_VERSION_NO_V']
          playwright_version = ENV['PW_VERSION']
          playwright_mcp_version = ENV['MCP_VERSION']
          sha256_intel = ENV['SHA256_INTEL']
          sha256_arm64 = ENV['SHA256_ARM64']
          sha256_linux = ENV['SHA256_LINUX']
          
          template = File.read('Formula/bugster.rb.erb')
          result = ERB.new(template).result(binding)
          File.write('Formula/bugster.rb', result)
          
          puts "Generated Formula/bugster.rb from template"
          RUBY

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet Formula/bugster.rb; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            git diff Formula/bugster.rb
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.changed == 'true'
        run: |
          git add Formula/bugster.rb
          git commit -m "Update Bugster formula to v${{ steps.versions.outputs.bugster_version_no_v }}"
          git push
          
          # Create a tag for this formula version (optional, for better traceability)
          TAG_NAME="formula-v${{ steps.versions.outputs.bugster_version_no_v }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping tag creation"
          else
            git tag -a "$TAG_NAME" -m "Bugster formula v${{ steps.versions.outputs.bugster_version_no_v }}"
            git push origin "$TAG_NAME"
            echo "Created and pushed tag: $TAG_NAME"
          fi

